<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IG Post Advisor â€“ High-Conversion Instagram Ideas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background: #0f172a; color: #e2e8f0; }
    #messages { scroll-behavior: smooth; }
    .user-msg { background: #1e293b; align-self: flex-end; }
    .bot-msg { background: #334155; align-self: flex-start; }
  </style>
</head>
<body class="flex flex-col h-screen">

  <header class="bg-gradient-to-r from-purple-900 to-indigo-900 p-4 shadow-lg">
    <h1 class="text-2xl font-bold text-center">IG Post Advisor</h1>
    <p class="text-center text-sm opacity-90">Get viral Instagram post ideas for high-interest savings & insurance (paycheck-to-paycheck audience)</p>
  </header>

  <div id="messages" class="flex-1 overflow-y-auto p-6 space-y-4"></div>

  <form id="chatForm" class="p-4 bg-slate-900 flex gap-3">
    <input type="text" id="userInput" autocomplete="off" placeholder="Ask for your next Instagram post idea..."
           class="flex-1 bg-slate-800 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-600" required />
    <button type="submit" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-semibold">
      Send
    </button>
  </form>

<script>
let messageHistory = [];

function addMessage(content, isBot = false) {
  const chat = document.getElementById('chat');
  const div = document.createElement('div');
  div.className = `message ${isBot ? 'bot' : 'user'}`;
  
  // è‡ªå‹•åŠ æ›è¡ŒåŒç©ºè¡Œï¼Œä»¤æ®µè½æ›´éš
  if (isBot) {
    const formatted = content
      .replace(/\n\n/g, '</p><p>')
      .replace(/\n/g, '<br>')
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/ã€(.*?)ã€‘/g, '<mark>$1</mark>');
    div.innerHTML = `<p>${formatted}</p>`;
  } else {
    div.textContent = content;
  }
  
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

async function sendMessage() {
  const input = document.getElementById('input');
  const msg = input.value.trim();
  if (!msg) return;
  
  addMessage(msg, false);
  input.value = '';
  
  // å³åˆ»é¡¯ç¤º Loading
  const loadingDiv = document.createElement('div');
  loadingDiv.className = 'message bot loading';
  loadingDiv.innerHTML = '<p>ğŸ¤” è«—ç·Šç·Šâ€¦ ç­‰æˆ‘ 10 ç§’å‘€ï¼</p>';
  document.getElementById('chat').appendChild(loadingDiv);
  document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
  
  messageHistory.push({ role: 'user', content: msg });
  
  const res = await fetch('/api/chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ message: msg, history: messageHistory })
  });
  
  // åˆªé™¤ Loading
  loadingDiv.remove();
  
  const data = await res.json();
  const reply = data.reply || 'ï¼ˆç³»çµ±å¿™ç·Šï¼Œé²å•²å†è©¦å•¦ï¼‰';
  
  addMessage(reply, true);
  messageHistory.push({ role: 'assistant', content: reply });
}

document.getElementById('input').addEventListener('keypress', e => {
  if (e.key === 'Enter') sendMessage();
});
</script>
</body>

</html>
